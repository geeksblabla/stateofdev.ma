---
import { Image } from "astro:assets";
import finImage from "@/assets/fin.jpeg";
---

<div
  id="exitModal"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50"
  role="dialog"
  aria-labelledby="modalTitle"
  aria-modal="true"
>
  <div
    class="bg-card border-4 border-border max-w-md w-full text-center relative"
  >
    <span
      id="closeModal"
      class="absolute top-2 right-2 text-muted-foreground cursor-pointer hover:text-foreground transition-colors"
      aria-label="Close modal">&times;</span
    >
    <Image
      src={finImage}
      alt="Funny meme encouraging survey completion"
      class="mx-auto border-b-2 border-border"
    />
    <button
      id="stayButton"
      class="bg-primary text-primary-foreground font-bold px-4 py-4 w-full border-t-2 border-primary hover:opacity-90 transition-opacity text-base"
    >
      ğŸ˜‚ Ù…ØºØ§Ø¯ÙŠ ÙÙŠÙ†ØŒ Ø§Ù†Ø§ Ù†ÙƒÙ…Ù„
    </button>
  </div>
</div>

<script>
  const body = document.body;
  let popupShownCount = 0;
  const maxPopupShows = 2;

  const modal = document.getElementById("exitModal") as HTMLDivElement;
  const closeModal = document.getElementById("closeModal") as HTMLSpanElement;
  const stayButton = document.getElementById("stayButton") as HTMLButtonElement;

  const closeModalHandler = () => {
    modal.classList.add("hidden");
  };

  const outsideClickHandler = (event: MouseEvent) => {
    if (event.target === modal) {
      modal.classList.add("hidden");
    }
  };

  const mouseLeaveHandler = () => {
    if (popupShownCount < maxPopupShows) {
      modal.classList.remove("hidden");
      popupShownCount++;
    }
  };

  if (body && modal && closeModal && stayButton) {
    body.addEventListener("mouseleave", mouseLeaveHandler);
    closeModal.addEventListener("click", closeModalHandler);
    stayButton.addEventListener("click", closeModalHandler);
    window.addEventListener("click", outsideClickHandler);

    // Cleanup on page unload
    window.addEventListener("beforeunload", () => {
      body.removeEventListener("mouseleave", mouseLeaveHandler);
      closeModal.removeEventListener("click", closeModalHandler);
      stayButton.removeEventListener("click", closeModalHandler);
      window.removeEventListener("click", outsideClickHandler);
    });
  }
</script>
