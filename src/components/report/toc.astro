---
interface TocItem {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  items: TocItem[];
}

const { items } = Astro.props;
---

<div>
  <nav
    class="md:block lg:block pb-12 w-full md:w-[300px] max-h-screen overflow-y-auto overflow-x-visible md:sticky md:top-0"
  >
    <div class="overflow-x-visible relative pl-[1.5px]">
      <h2 class="text-lg font-bold mb-4 px-6 text-foreground hidden md:block">
        On this page
      </h2>
      <ul
        id="toc-list"
        class="px-6 py-6 z-20 border-l border-solid border-border hidden md:block"
      >
        {
          items.map((item) => (
            <li class={`text-sm ${item.depth > 1 ? "ml-4" : ""} relative`}>
              <a
                href={`#${item.slug}`}
                class={`underline-offset-4 ${item.depth > 1 ? "text-xs" : "text-sm"} inline-flex items-center hover:text-primary transition-colors duration-300 hover:underline py-1 `}
                data-toc-item
              >
                {item.text}
              </a>
            </li>
          ))
        }
      </ul>
      <div
        id="active-indicator"
        class="z-10 absolute left-[1px] w-full bg-primary/10 transition-all duration-200 ease-in-out border-l-2 border-solid border-primary hidden md:block"
      >
      </div>
    </div>
  </nav>
  <button
    id="toc-toggle"
    class="fixed bottom-4 right-4 bg-muted text-white p-3 border-2 border-muted md:hidden z-50"
    aria-label="Toggle Table of Contents"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M4 6h16M4 10h16M4 14h16M4 18h8"></path>
    </svg>
  </button>
</div>

<script>
  function updateActiveItem() {
    const tocItems = document.querySelectorAll("[data-toc-item]");
    const headings = Array.from(document.querySelectorAll("h1, h2"));
    const activeIndicator = document.getElementById("active-indicator");

    // Find items that are currently visible in the viewport
    const activeItems = [];
    const viewportHeight = window.innerHeight;

    headings.forEach((heading) => {
      const rect = heading.getBoundingClientRect();
      // Check if heading is visible in viewport (between top and bottom of screen)
      if (rect.top >= -100 && rect.top <= viewportHeight - 100) {
        const tocLink = document.querySelector(`[href="#${heading.id}"]`);
        if (tocLink && !activeItems.includes(tocLink)) {
          activeItems.push(tocLink);
        }
      }
    });

    // Update visual states for ALL items
    tocItems.forEach((item) => {
      if (activeItems.includes(item)) {
        item.classList.add("text-primary", "font-bold");
      } else {
        item.classList.remove("text-primary", "font-bold");
      }
    });

    // Update indicator bar to span from first to last active item
    if (activeItems.length > 0 && activeIndicator) {
      const navElement = activeItems[0]?.closest("nav");
      const navRect = navElement?.getBoundingClientRect();

      if (navElement && navRect) {
        const navScrollTop = navElement.scrollTop;

        // Get position of first active item
        const firstItemRect = activeItems[0].getBoundingClientRect();
        const firstTop = firstItemRect.top - navRect.top + navScrollTop;

        // Get position of last active item
        const lastActiveItem = activeItems[activeItems.length - 1];
        const lastItemRect = lastActiveItem.getBoundingClientRect();
        const lastBottom =
          lastItemRect.top - navRect.top + lastItemRect.height + navScrollTop;

        // Set indicator to span the range
        activeIndicator.style.top = `${firstTop}px`;
        activeIndicator.style.height = `${lastBottom - firstTop}px`;

        // Ensure the last active item is visible in the nav with smooth scrolling
        const lastTop = lastItemRect.top - navRect.top;
        const lastItemBottom = lastTop + lastItemRect.height;
        const navHeight = navElement.clientHeight;
        const DELTA_SCROLL = 400;

        if (lastTop < 0) {
          navElement.scrollTo({
            top: navElement.scrollTop + lastTop - DELTA_SCROLL,
            behavior: "smooth"
          });
        } else if (lastItemBottom > navHeight) {
          navElement.scrollTo({
            top:
              navElement.scrollTop +
              (lastItemBottom - navHeight) +
              DELTA_SCROLL,
            behavior: "smooth"
          });
        }
      }
    }
  }

  function toggleToc() {
    const tocList = document.getElementById("toc-list");
    const tocToggle = document.getElementById("toc-toggle");

    if (tocList && tocToggle) {
      tocList.classList.toggle("hidden");
      tocList.classList.toggle("fixed");
      tocList.classList.toggle("inset-0");
      tocList.classList.toggle("bg-card");
      tocList.classList.toggle("z-50");
      tocList.classList.toggle("overflow-y-auto");

      if (!tocList.classList.contains("hidden")) {
        tocToggle.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
      } else {
        tocToggle.innerHTML =
          '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h8" /></path></svg>';
      }
    }
  }

  function hideTocOnMobile() {
    const tocList = document.getElementById("toc-list");
    const tocToggle = document.getElementById("toc-toggle");

    if (tocList && tocToggle && window.innerWidth < 768) {
      tocList.classList.add("hidden");
      tocList.classList.remove(
        "fixed",
        "inset-0",
        "bg-card",
        "z-50",
        "overflow-y-auto"
      );
      tocToggle.innerHTML =
        '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h8" /></path></svg>';
    }
  }

  window.addEventListener("scroll", updateActiveItem);
  window.addEventListener("load", updateActiveItem);

  const tocToggle = document.getElementById("toc-toggle");
  if (tocToggle) {
    tocToggle.addEventListener("click", toggleToc);
  }

  const tocLinks = document.querySelectorAll("[data-toc-item]");
  tocLinks.forEach((link) => {
    link.addEventListener("click", hideTocOnMobile);
  });

  window.addEventListener("resize", hideTocOnMobile);
</script>
