---
import { LanguagePicker } from "@/components/language-picker";
import BaseLayout from "@/components/layout.astro";
import { translations } from "@/lib/translations";

const lang = (Astro.url.searchParams.get("lang") || "en") as "en" | "ar";
const t = translations[lang].beforeStart;

export const prerender = false;
---

<BaseLayout>
  <div class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <div class="bg-card border-2 border-border">
      <div class="p-6 sm:p-8">
        <h1
          class="text-xl font-sans font-medium text-foreground mb-6 text-center"
        >
          {t.title}
        </h1>

        <LanguagePicker client:load />

        <p class="text-base text-foreground mb-8">
          {t.intro}
        </p>
        <ul class="space-y-4 mb-8">
          {
            t.rules.map((rule, index) => (
              <li class="flex items-start gap-3">
                <span class="flex h-6 w-6 shrink-0 items-center justify-center border-2 border-input bg-muted text-sm font-medium text-muted-foreground mt-0.5">
                  {index + 1}
                </span>
                <span
                  class="text-foreground leading-relaxed"
                  set:html={rule.replace(
                    /\*\*(.*?)\*\*/g,
                    "<strong>$1</strong>"
                  )}
                />
              </li>
            ))
          }
        </ul>

        <div id="captcha-container" class="mb-6 mx-auto w-fit"></div>
        <div
          id="error-alert"
          class="hidden mb-6 p-4 bg-destructive/10 border-l-4 border-destructive text-destructive"
          role="alert"
        >
          <p id="error-message" class="font-medium"></p>
        </div>
        <button
          id="start-survey-btn"
          class="w-full bg-primary hover:opacity-90 text-primary-foreground font-bold py-3 px-6 border-2 border-primary transition duration-300 ease-in-out transform focus:outline-none focus:ring-2 focus:ring-ring focus:ring-opacity-50"
        >
          {t.start}
        </button>
      </div>
    </div>
  </div>
</BaseLayout>

<script
  src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback"
  defer
  is:inline
></script>

<script>
/* eslint-disable no-console */
import { actions } from "astro:actions";
import { signInAnonymously } from "firebase/auth";
import { auth } from "@/lib/firebase/client";
import { translations } from "@/lib/translations";

const startButton = document.querySelector(
  "#start-survey-btn"
) as HTMLButtonElement;
const errorAlert = document.querySelector("#error-alert") as HTMLDivElement;
const errorMessage = document.querySelector(
  "#error-message"
) as HTMLParagraphElement;
let captchaToken = "";
// @ts-expect-error - Turnstile callback is added to window dynamically
window.onloadTurnstileCallback = function () {
  // @ts-expect-error - Turnstile is added to window dynamically by Cloudflare script
  window.turnstile.render("#captcha-container", {
    sitekey: "0x4AAAAAAAkS5usDr1HhE7Gm",
    callback(token: string) {
      console.log(`Challenge Success ${token}`);
      captchaToken = token;
    },
    theme: "auto"
  });
};

const lang = new URLSearchParams(window.location.search).get("lang") || "en";
const t = translations[lang as "en" | "ar"].beforeStart;

function handleError() {
  errorMessage.innerHTML = `Session initialization failed. Please try again or <a href="https://github.com/geeksblabla/stateofdev.ma/issues" target="_blank" class="underline font-semibold">report the issue</a>.`;
  errorAlert.classList.remove("hidden");
  startButton.innerHTML = t.start;
  startButton.disabled = false;
  startButton.classList.remove("opacity-50", "cursor-not-allowed");
}

startButton.addEventListener("click", async () => {
  startButton.disabled = true;
  startButton.innerHTML = t.initializing;
  startButton.classList.add("opacity-50", "cursor-not-allowed");
  errorAlert.classList.add("hidden");

  try {
    const userCredential = await signInAnonymously(auth);
    const token = await userCredential.user.getIdToken();

    const { error } = await actions.initSession({
      idToken: token,
      captchaToken
    });
    if (error) {
      console.error("Error initializing session:", error);
      handleError();
      return;
    }

    // Redirect to the survey page with lang param
    window.location.href = `/survey?lang=${lang}`;
  }
  catch {
    handleError();
  }
});
</script>
