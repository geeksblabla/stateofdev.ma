---
import BaseLayout from "@/components/layout.astro";

const rules = [
  "We care about privacy; that's why all your answers are **completely anonymous**. We only rely on anonymous sessions to avoid spam",
  "**Please be honest**. Our goal is to understand the Moroccan IT market and share results with the community.",
  "The Survey should take around **8 minutes** to complete",
  "The survey is divided into **6 parts**: Profile, Learning & Education, AI, Work, Technology, and Community,(we submit your answers at the end of each part)",
  "All Questions are **required** unless you have a **skip button**",
  "For questions that accept others as an option, please add them in the **text field**",
  "There are two types of questions: **Multiple Choice** (select one or more options) and **Single Select** (choose only one option)"
];

export const prerender = true;
---

<BaseLayout>
  <div class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <div class="bg-card border-2 border-border">
      <div class="p-6 sm:p-8">
        <h1
          class="text-xl font-sans font-medium text-foreground mb-6 text-center"
        >
          Before You Start
        </h1>
        <p class="text-base text-foreground mb-8">
          Here's what you need to know:
        </p>
        <ul class="space-y-4 mb-8">
          {
            rules.map((rule, index) => (
              <li class="flex items-start gap-3">
                <span class="flex h-6 w-6 shrink-0 items-center justify-center border-2 border-input bg-muted text-sm font-medium text-muted-foreground mt-0.5">
                  {index + 1}
                </span>
                <span
                  class="text-foreground leading-relaxed"
                  set:html={rule.replace(
                    /\*\*(.*?)\*\*/g,
                    "<strong>$1</strong>"
                  )}
                />
              </li>
            ))
          }
        </ul>

        <div id="captcha-container" class="mb-6 mx-auto w-fit"></div>
        <div
          id="error-alert"
          class="hidden mb-6 p-4 bg-destructive/10 border-l-4 border-destructive text-destructive"
          role="alert"
        >
          <p id="error-message" class="font-medium"></p>
        </div>
        <button
          id="start-survey-btn"
          class="w-full bg-primary hover:opacity-90 text-primary-foreground font-bold py-3 px-6 border-2 border-primary transition duration-300 ease-in-out transform focus:outline-none focus:ring-2 focus:ring-ring focus:ring-opacity-50"
        >
          Start
        </button>
      </div>
    </div>
  </div>
</BaseLayout>

<script
  src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onloadTurnstileCallback"
  defer
  is:inline
></script>

<script>
import { actions } from "astro:actions";
import { signInAnonymously } from "firebase/auth";
import { auth } from "@/lib/firebase/client";

const startButton = document.querySelector(
  "#start-survey-btn"
) as HTMLButtonElement;
const errorAlert = document.querySelector("#error-alert") as HTMLDivElement;
const errorMessage = document.querySelector(
  "#error-message"
) as HTMLParagraphElement;
let captchaToken = "";
// @ts-expect-error - Turnstile callback is added to window dynamically
window.onloadTurnstileCallback = function () {
  // @ts-expect-error - Turnstile is added to window dynamically by Cloudflare script
  window.turnstile.render("#captcha-container", {
    sitekey: "0x4AAAAAAAkS5usDr1HhE7Gm",
    callback(token: string) {
      console.warn(`Challenge Success ${token}`);
      captchaToken = token;
    },
    theme: "auto"
  });
};

function handleError() {
  errorMessage.innerHTML = `Session initialization failed. Please try again or <a href="https://github.com/geeksblabla/stateofdev.ma/issues" target="_blank" class="underline font-semibold">report the issue</a>.`;
  errorAlert.classList.remove("hidden");
  startButton.innerHTML = "Start Survey";
  startButton.disabled = false;
  startButton.classList.remove("opacity-50", "cursor-not-allowed");
}

startButton.addEventListener("click", async () => {
  startButton.disabled = true;
  startButton.innerHTML = "Initializing Session...";
  startButton.classList.add("opacity-50", "cursor-not-allowed");
  errorAlert.classList.add("hidden");

  try {
    const userCredential = await signInAnonymously(auth);
    const token = await userCredential.user.getIdToken();

    const { error } = await actions.initSession({
      idToken: token,
      captchaToken
    });
    if (error) {
      console.error("Error initializing session:", error);
      handleError();
      return;
    }

    // Redirect to the survey page or reload as needed
    window.location.href = "/survey";
  }
  catch {
    handleError();
  }
});
</script>
